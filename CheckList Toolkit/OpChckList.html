<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸…å•å·¥å…·ç®± v1</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background-color: #f8f9fa;
            padding-top: 130px;
        }
        .input-group-fixed {
            position: fixed;
            top: 0;
            width: 100%;
            max-width: 1200px;
            background-color: #fff;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1030;
            margin: 0 auto;
            left: 0;
            right: 0;
            border-bottom: 1px solid #dee2e6;
        }
        .preview-img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 4px;
            transition: transform 0.2s;
        }
        .preview-img:hover {
            transform: scale(1.5);
        }
        
        /* æ‚¬æµ®æ¶ˆæ¯åŒºåŸŸ */
        #floating-message {
            position: fixed;
            top: 85px;
            left: 50%;
            transform: translateX(-50%);
            min-width: 300px;
            max-width: 80%;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 2000; /* æœ€é«˜å±‚çº§ */
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none; /* å…è®¸ç‚¹å‡»ç©¿é€ */
        }
        
        #floating-message.show {
            opacity: 1;
        }
        
        /* é€šçŸ¥ç³»ç»Ÿæ ·å¼ */
        #notification-area {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            z-index: 1500;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        
        .notification {
            padding: 12px 15px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 10px;
            transform: translateX(110%);
            transition: transform 0.3s ease-out;
            opacity: 0.95;
            animation: slide-in 0.3s forwards, fade-out 0.5s 2.5s forwards;
            display: flex;
            align-items: center;
            justify-content: space-between;
            pointer-events: auto;
        }
        
        @keyframes slide-in {
            to { transform: translateX(0); }
        }
        
        @keyframes fade-out {
            to { opacity: 0; transform: translateY(10px); }
        }
        
        .notification-success {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        
        .notification-info {
            background-color: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        
        .notification-warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }
        
        .notification-danger {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        
        .notification-close {
            cursor: pointer;
            font-size: 18px;
            color: inherit;
            background: none;
            border: none;
            padding: 0 5px;
            opacity: 0.7;
            margin-left: 8px;
        }
        
        .notification-close:hover {
            opacity: 1;
        }
        
        /* æ—¥å¿—æ§åˆ¶å°æ ·å¼ */
        #console-log {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 350px;
            max-height: 200px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1400;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        #console-log .log-entry {
            margin: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 3px;
        }
        
        #console-log .log-time {
            color: #aaa;
            margin-right: 5px;
        }
        
        #console-log .log-info {
            color: #8adbff;
        }
        
        #console-log .log-error {
            color: #ff8a8a;
        }
        
        #console-log .log-warning {
            color: #ffcc66;
        }
        
        #console-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        #console-header button {
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            padding: 0 5px;
            font-size: 14px;
        }
        
        #console-header button:hover {
            color: #fff;
        }
        
        .icon-btn {
            width: 40px;
            text-align: center;
            position: relative;
        }
        
        .toggle-btn {
            padding: 2px 8px;
            min-width: 80px;
            text-align: center;
        }
        
        .btn-purple {
            background-color: #6f42c1;
            color: white;
        }
        
        .btn-purple:hover {
            background-color: #5a32a3;
            color: white;
        }
        
        .edit-inputs {
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
            margin-top: 10px;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .table thead {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .table th {
            background-color: #f8f9fa;
        }
        
        .table td {
            vertical-align: middle;
            padding: 0.75rem;
        }
        
        .table-striped > tbody > tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .table-container .table {
            border-radius: 8px;
            overflow: hidden;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        /* é¡µé¢é”å®šæŒ‡ç¤ºå™¨ */
        .page-lock-indicator {
            position: fixed;
            top: 15px;
            right: 20px;
            z-index: 2100;
            font-size: 1.25rem;
            color: #495057;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.7);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        
        .page-lock-indicator:hover {
            background-color: rgba(255, 255, 255, 0.9);
            transform: scale(1.05);
        }
        
        .page-locked {
            color: #dc3545;
        }
        
        @media (max-width: 768px) {
            body {
                padding-top: 170px;
            }
            .input-group-fixed {
                padding: 10px;
            }
            .table-container {
                margin-top: 30px;
            }
            #notification-area {
                width: calc(100% - 40px);
                max-width: 500px;
            }
            #floating-message {
                width: 90%;
                max-width: none;
                top: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å›ºå®šåœ¨é¡¶éƒ¨çš„è¾“å…¥ç»„ -->
        <div class="input-group-fixed">
            <h4 class="mb-3">æ¸…å•å·¥å…·ç®± v1</h4>
            <div class="input-group mb-2">
                <button class="btn btn-primary icon-btn" id="loadBtn" title="åŠ è½½å·²ä¿å­˜çš„æ¸…å•">ğŸ“‚</button>
                <input type="text" class="form-control" id="titleInput" placeholder="è¾“å…¥æ ‡é¢˜">
                <input type="text" class="form-control" id="contentInput" placeholder="è¾“å…¥å†…å®¹">
                <input type="text" class="form-control" id="imageUrlInput" placeholder="å›¾ç‰‡é“¾æ¥ï¼ˆæˆ–ä½¿ç”¨ç²˜è´´æˆªå›¾æŒ‰é’®ï¼‰" readonly>
                <button class="btn btn-warning icon-btn" id="pasteBtn" title="ç²˜è´´æˆªå›¾">ğŸ“‹</button>
                <button class="btn btn-success icon-btn" id="addBtn" title="æ·»åŠ é¡¹ç›®">â•</button>
                <button class="btn btn-info icon-btn" id="saveBtn" title="ä¿å­˜æ¸…å•">ğŸ’¾</button>
                <button class="btn btn-secondary icon-btn" id="resetBtn" title="é‡ç½®æ¸…å•">ğŸ”„</button>
                <button class="btn btn-outline-secondary icon-btn" id="toggleLogBtn" title="æ˜¾ç¤º/éšè—æ—¥å¿—">ğŸ”</button>
                <button class="btn btn-outline-success icon-btn" id="exportBtn" title="å¯¼å‡ºæ¸…å•ä¸å›¾ç‰‡">ğŸ“¤</button>
            </div>
        </div>
        
        <!-- é¡µé¢é”å®šæŒ‰é’® -->
        <div class="page-lock-indicator" id="pageLockBtn" title="é”å®š/è§£é”é¡µé¢">ğŸ”“</div>
        
        <!-- æµ®åŠ¨æ¶ˆæ¯ (ç”¨äºæ˜¾ç¤ºé‡è¦æ—¥å¿—) -->
        <div id="floating-message"></div>
        
        <!-- é€šçŸ¥åŒºåŸŸ -->
        <div id="notification-area"></div>
        
        <!-- æ—¥å¿—æ§åˆ¶å°åŒºåŸŸ -->
        <div id="console-log">
            <div id="console-header">
                <span>æ§åˆ¶å°æ—¥å¿—</span>
                <div>
                    <button id="clearLogBtn" title="æ¸…ç©ºæ—¥å¿—">ğŸ—‘ï¸</button>
                    <button id="closeLogBtn" title="å…³é—­">âœ–</button>
                </div>
            </div>
            <div id="console-content"></div>
        </div>
        
        <div class="table-container">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th style="width: 10%;">çŠ¶æ€</th>
                        <th style="width: 5%;">åºå·</th>
                        <th style="width: 20%;">æ ‡é¢˜</th>
                        <th style="width: 25%;">å†…å®¹</th>
                        <th style="width: 15%;">é¢„è§ˆ</th>
                        <th style="width: 25%;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="checklistBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let checklist = [];
        let imageIndex = 1;
        let logVisible = false;
        let floatingMessageTimeout = null;
        let pageIsLocked = false;
        let imageBlobs = new Map(); // å­˜å‚¨å›¾ç‰‡blobçš„æ˜ å°„
        let tooltips = []; // å­˜å‚¨æ‰€æœ‰tooltipå®ä¾‹çš„æ•°ç»„ï¼Œç”¨äºæ‰‹åŠ¨å¤„ç†
        
        // ç¡®ä¿DOMå®Œå…¨åŠ è½½åå†æ‰§è¡ŒJavaScript
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMå®Œå…¨åŠ è½½ï¼Œåˆå§‹åŒ–æ¸…å•...');

            // åŠ è½½ä¹‹å‰ä¿å­˜çš„æ¸…å•
            checklist = JSON.parse(localStorage.getItem('checklist')) || [];
            
            // åˆå§‹åŒ–å·¥å…·æç¤º            initTooltips();
            
            // æŒ‰é’®äº‹ä»¶ç»‘å®š
            document.getElementById('loadBtn').onclick = loadChecklist;
            document.getElementById('pasteBtn').onclick = triggerPaste;
            document.getElementById('addBtn').onclick = addItem;
            document.getElementById('saveBtn').onclick = saveChecklist;
            document.getElementById('resetBtn').onclick = resetChecklist;
            document.getElementById('toggleLogBtn').onclick = toggleLogConsole;
            document.getElementById('clearLogBtn').onclick = clearLogConsole;
            document.getElementById('closeLogBtn').onclick = hideLogConsole;
            document.getElementById('exportBtn').onclick = exportChecklist;
            document.getElementById('pageLockBtn').onclick = togglePageLock;
            
            // ä¸ºå›¾ç‰‡è¾“å…¥æ·»åŠ ç²˜è´´ç›‘å¬å™¨
            const imageUrlInput = document.getElementById('imageUrlInput');
            if (imageUrlInput) {
                imageUrlInput.addEventListener('paste', handlePaste);
            }
            
            // æ·»åŠ è¡¨æ ¼äº‹ä»¶å§”æ‰˜
            document.getElementById('checklistBody').addEventListener('click', handleTableEvents);
            
            // æ·»åŠ ç¦»å¼€é¡µé¢å‰æç¤º
            window.addEventListener('beforeunload', handleBeforeUnload);
            
            // é¦–æ¬¡æ¸²æŸ“æ¸…å•
            renderChecklist();
            showFloatingMessage('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼', 'success', 2000);
        });
        
        // åˆå§‹åŒ–å·¥å…·æç¤º
        function initTooltips() {
            // é”€æ¯å…ˆå‰çš„å·¥å…·æç¤º
            if (tooltips.length > 0) {
                tooltips.forEach(tooltip => {
                    if (tooltip && typeof tooltip.dispose === 'function') {
                        tooltip.dispose();
                    }
                });
                tooltips = [];
            }
            
            // åˆ›å»ºæ–°çš„å·¥å…·æç¤ºå®ä¾‹
            const tooltipTriggerList = document.querySelectorAll('[title]');
            tooltips = [...tooltipTriggerList].map(element => {
                return new bootstrap.Tooltip(element, {
                    trigger: 'hover focus',
                    delay: { show: 500, hide: 100 }
                });
            });
        }
        
        // æ˜¾ç¤ºæµ®åŠ¨æ¶ˆæ¯
        function showFloatingMessage(message, type = 'info', duration = 3000) {
            const messageEl = document.getElementById('floating-message');
            if (!messageEl) return;
            
            // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
            if (floatingMessageTimeout) {
                clearTimeout(floatingMessageTimeout);
            }
            
            // è®¾ç½®æ¶ˆæ¯é¢œè‰²
            let color = '#17a2b8'; // info
            if (type === 'error') color = '#dc3545';
            if (type === 'warning') color = '#ffc107';
            if (type === 'success') color = '#28a745';
            
            messageEl.style.backgroundColor = `rgba(0, 0, 0, 0.85)`;
            messageEl.style.borderLeft = `4px solid ${color}`;
            messageEl.textContent = message;
            messageEl.classList.add('show');
            
            // è®¾ç½®è‡ªåŠ¨éšè—
            floatingMessageTimeout = setTimeout(() => {
                messageEl.classList.remove('show');
            }, duration);
        }
        
        // é˜»æ­¢é¡µé¢åˆ·æ–°æç¤º
        function handleBeforeUnload(event) {
            if (pageIsLocked || imageBlobs.size > 0) {
                const message = 'è­¦å‘Šï¼šæ‚¨æœ‰æœªä¿å­˜çš„å›¾ç‰‡ã€‚è¯·åœ¨ç¦»å¼€å‰å¯¼å‡ºã€‚';
                event.returnValue = message;
                return message;
            }
        }
        
        // åˆ‡æ¢é¡µé¢é”å®šçŠ¶æ€
        function togglePageLock() {
            pageIsLocked = !pageIsLocked;
            const lockBtn = document.getElementById('pageLockBtn');
            
            if (pageIsLocked) {
                lockBtn.textContent = 'ğŸ”’';
                lockBtn.classList.add('page-locked');
                showFloatingMessage('é¡µé¢å·²é”å®šã€‚åˆ·æ–°å°†è¢«é˜»æ­¢ã€‚', 'info');
            } else {
                lockBtn.textContent = 'ğŸ”“';
                lockBtn.classList.remove('page-locked');
                showFloatingMessage('é¡µé¢å·²è§£é”ã€‚', 'info');
            }
        }
        
        // æ—¥å¿—æ§åˆ¶å°åŠŸèƒ½
        function toggleLogConsole() {
            const logConsole = document.getElementById('console-log');
            logVisible = !logVisible;
            logConsole.style.display = logVisible ? 'block' : 'none';
        }
        
        function hideLogConsole() {
            const logConsole = document.getElementById('console-log');
            logVisible = false;
            logConsole.style.display = 'none';
        }
        
        function clearLogConsole() {
            const consoleContent = document.getElementById('console-content');
            if (consoleContent) {
                consoleContent.innerHTML = '';
            }
        }
        
        // æ·»åŠ æ—¥å¿—æ¡ç›®
        function addLogEntry(message, type = 'info') {
            const consoleContent = document.getElementById('console-content');
            if (!consoleContent) return;
            
            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="log-time">${timeStr}</span> ${message}`;
            
            consoleContent.appendChild(logEntry);
            consoleContent.scrollTop = consoleContent.scrollHeight;
        }
        
        // å¤„ç†è¡¨æ ¼äº‹ä»¶
        function handleTableEvents(event) {
            const target = event.target;
            const button = target.closest('button');
            if (!button) return;
            
            const action = button.getAttribute('data-action');
            const index = parseInt(button.getAttribute('data-index'), 10);
            
            if (action === 'toggle') {
                toggleDone(index);
            } else if (action === 'edit') {
                editItem(index);
            } else if (action === 'remove') {
                removeItem(index);
            } else if (action === 'copy') {
                copyItem(index);
            } else if (action === 'saveEdit') {
                saveEdit(index);
            } else if (action === 'cancelEdit') {
                cancelEdit(index);
            }
        }

        // ä»localStorageåŠ è½½æ¸…å•
        function loadChecklist() {
            checklist = JSON.parse(localStorage.getItem('checklist')) || [];
            renderChecklist();
            showFloatingMessage('æ¸…å•å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½æˆåŠŸï¼', 'success');
        }

        // è§¦å‘ç²˜è´´åŠŸèƒ½
        function triggerPaste() {
            const pasteInput = document.getElementById('imageUrlInput');
            if (pasteInput) {
                pasteInput.focus();
                showFloatingMessage('è¯·æŒ‰ Ctrl+V å°†æˆªå›¾ç²˜è´´åˆ°è¾“å…¥æ¡†', 'info');
            } else {
                showFloatingMessage('é”™è¯¯ï¼šæ— æ³•è§¦å‘ç²˜è´´ - æœªæ‰¾åˆ°è¾“å…¥æ¡†', 'error');
            }
        }

        // å¤„ç†ç²˜è´´äº‹ä»¶
        function handlePaste(event) {
            event.preventDefault();
            const items = event.clipboardData.items;
            if (!items || items.length === 0) {
                showFloatingMessage('å‰ªè´´æ¿ä¸­æ— å¯ç”¨æ•°æ®ã€‚è¯·ç¡®ä¿å·²å¤åˆ¶å›¾ç‰‡', 'warning');
                return;
            }

            for (let item of items) {
                if (item.type.startsWith('image/')) {
                    const blob = item.getAsFile();
                    if (!blob) {
                        showFloatingMessage('æ— æ³•ä»å‰ªè´´æ¿è·å–å›¾ç‰‡ã€‚è¯·é‡è¯•', 'error');
                        return;
                    }
                    
                    // ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦ä½œä¸ºå›¾ç‰‡ID
                    const imageId = `img_${Date.now()}_${imageIndex}`;
                    imageIndex++;
                    
                    // å­˜å‚¨Blobåˆ°æ˜ å°„ä¸­
                    imageBlobs.set(imageId, blob);
                    
                    // åˆ›å»ºä¸´æ—¶URLç”¨äºæ˜¾ç¤º
                    const dataUrl = URL.createObjectURL(blob);
                    
                    // æ•è·å½“å‰æ ‡é¢˜å’Œå†…å®¹ä½œä¸ºä¸Šä¸‹æ–‡
                    const title = document.getElementById('titleInput').value.trim() || 'æˆªå›¾';
                    const content = document.getElementById('contentInput').value.trim() || 'ç²˜è´´çš„å›¾ç‰‡';
                    
                    checklist.push({ 
                        title, 
                        content, 
                        imagePath: dataUrl, 
                        imageId: imageId,
                        done: false 
                    });
                    
                    saveChecklist();
                    renderChecklist();
                    showFloatingMessage('å›¾ç‰‡å·²ç²˜è´´ï¼Œé¡¹ç›®å·²æ·»åŠ æˆåŠŸï¼', 'success');
                    
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('titleInput').value = '';
                    document.getElementById('contentInput').value = '';
                    document.getElementById('imageUrlInput').value = '';
                    return;
                }
            }
            
            showFloatingMessage('å‰ªè´´æ¿æ•°æ®ä¸æ˜¯å›¾ç‰‡ã€‚è¯·å¤åˆ¶å›¾ç‰‡åé‡è¯•', 'warning');
        }

        // æ·»åŠ æ–°é¡¹ç›®
        function addItem() {
            const title = document.getElementById('titleInput').value.trim();
            const content = document.getElementById('contentInput').value.trim();
            const imageUrl = document.getElementById('imageUrlInput').value.trim();

            if (title && content) {
                checklist.push({ 
                    title, 
                    content, 
                    imagePath: imageUrl || '',
                    done: false 
                });
                
                saveChecklist();
                renderChecklist();
                showFloatingMessage('æ–°é¡¹ç›®å·²æ·»åŠ æˆåŠŸï¼', 'success');
                
                // æ¸…ç©ºè¾“å…¥
                document.getElementById('titleInput').value = '';
                document.getElementById('contentInput').value = '';
                document.getElementById('imageUrlInput').value = '';
            } else {
                showFloatingMessage('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹å­—æ®µ', 'warning');
            }
        }

        // å¯¼å‡ºæ¸…å•å’Œå›¾ç‰‡
        function exportChecklist() {
            // å¦‚æœæ²¡æœ‰å›¾ç‰‡æ•°æ®ï¼Œåªå¯¼å‡ºJSON
            if (imageBlobs.size === 0) {
                exportJsonFile();
                showFloatingMessage('å¯¼å‡ºæˆåŠŸï¼ˆæ— å›¾ç‰‡æ•°æ®ï¼‰', 'success');
                return;
            }
            
            // åŠ è½½JSZipåº“å¹¶åˆ›å»ºZIP
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
            script.onload = function() {
                const zip = new JSZip();
                
                // æ·»åŠ æ¸…å•æ•°æ®
                const checklistData = JSON.stringify(checklist, null, 2);
                zip.file('checklist.json', checklistData);
                
                // æ·»åŠ å›¾ç‰‡æ–‡ä»¶
                imageBlobs.forEach((blob, imageId) => {
                    zip.file(`images/${imageId}.png`, blob);
                });
                
                // ç”ŸæˆZIPæ–‡ä»¶å¹¶ä¸‹è½½
                zip.generateAsync({type: 'blob'}).then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `checklist_export_${new Date().toISOString().slice(0, 10)}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showFloatingMessage('å¯¼å‡ºå®Œæˆï¼', 'success');
                });
            };
            
            script.onerror = function() {
                console.error('æ— æ³•åŠ è½½JSZipåº“');
                showFloatingMessage('å¯¼å‡ºå¤±è´¥ï¼Œé™çº§ä¸ºä»…å¯¼å‡ºJSON', 'warning');
                exportJsonFile();
            };
            
            document.head.appendChild(script);
        }
        
        // ä»…å¯¼å‡ºJSONæ–‡ä»¶
        function exportJsonFile() {
            const data = JSON.stringify(checklist, null, 2);
            const blob = new Blob([data], {type: 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `checklist_export_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // æ¸²æŸ“æ¸…å•
        function renderChecklist() {
            const tbody = document.getElementById('checklistBody');
            if (!tbody) {
                showFloatingMessage('é”™è¯¯: æœªæ‰¾åˆ°æ¸…å•è¡¨æ ¼ä¸»ä½“', 'error');
                return;
            }
            
            tbody.innerHTML = '';
            
            if (checklist.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="text-center py-4">
                        <div class="text-muted">æ¸…å•ä¸­æ²¡æœ‰é¡¹ç›®ã€‚ä½¿ç”¨ä¸Šæ–¹è¡¨å•æ·»åŠ é¡¹ç›®ã€‚</div>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary" onclick="document.getElementById('titleInput').focus()">
                                æ·»åŠ ç¬¬ä¸€ä¸ªé¡¹ç›® â•
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }
            
            checklist.forEach((item, index) => {
                const isDone = item.done || false;
                const doneClass = isDone ? 'text-decoration-line-through text-muted' : '';
                const hasImage = item.imagePath && item.imagePath.trim() !== '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <button class="btn btn-sm ${isDone ? 'btn-success' : 'btn-outline-secondary'} toggle-btn" 
                                data-action="toggle" data-index="${index}" title="${isDone ? 'æ ‡è®°ä¸ºæœªå®Œæˆ' : 'æ ‡è®°ä¸ºå·²å®Œæˆ'}">
                            ${isDone ? 'âœ“ å·²å®Œæˆ' : 'â—¯ æœªå®Œæˆ'}
                        </button>
                    </td>
                    <td>${index + 1}</td>
                    <td class="${doneClass}">${item.title}</td>
                    <td class="${doneClass}">${item.content}</td>
                    <td>${hasImage ? `<a href="${item.imagePath}" target="_blank"><img src="${item.imagePath}" alt="é¢„è§ˆ" class="preview-img"></a>` : 'æ— å›¾ç‰‡'}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" data-action="edit" data-index="${index}" title="ç¼–è¾‘é¡¹ç›®">âœï¸</button>
                            <button class="btn btn-danger btn-sm" data-action="remove" data-index="${index}" title="åˆ é™¤é¡¹ç›®">ğŸ—‘ï¸</button>
                        </div>
                        <div class="edit-inputs d-none" id="editInputs${index}">
                            <input type="text" class="form-control form-control-sm mb-2" id="editTitle${index}" value="${item.title}" placeholder="ç¼–è¾‘æ ‡é¢˜">
                            <input type="text" class="form-control form-control-sm mb-2" id="editContent${index}" value="${item.content}" placeholder="ç¼–è¾‘å†…å®¹">
                            <input type="text" class="form-control form-control-sm mb-2" id="editImageUrl${index}" value="${item.imagePath || ''}" placeholder="å›¾ç‰‡é“¾æ¥ï¼ˆå¯é€‰ï¼‰" readonly>
                            <div class="mt-2">
                                <button class="btn btn-info btn-sm" data-action="saveEdit" data-index="${index}">ä¿å­˜</button>
                                <button class="btn btn-secondary btn-sm" data-action="cancelEdit" data-index="${index}">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // é‡æ–°åˆå§‹åŒ–å·¥å…·æç¤º
            initTooltips();
        }

        // åˆ‡æ¢å®ŒæˆçŠ¶æ€
        function toggleDone(index) {
            if (checklist[index]) {
                checklist[index].done = !checklist[index].done;
                saveChecklist();
                renderChecklist();
                showFloatingMessage(`é¡¹ç›®å·²${checklist[index].done ? 'æ ‡è®°ä¸ºå·²å®Œæˆ' : 'æ ‡è®°ä¸ºæœªå®Œæˆ'}`, 'success');
            }
        }

        // åˆ é™¤é¡¹ç›®
        function removeItem(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ')) {
                // å¦‚æœæœ‰å…³è”çš„å›¾ç‰‡ï¼Œé‡Šæ”¾èµ„æº
                const item = checklist[index];
                if (item.imageId && imageBlobs.has(item.imageId)) {
                    URL.revokeObjectURL(item.imagePath);
                    imageBlobs.delete(item.imageId);
                }
                
                checklist.splice(index, 1);
                saveChecklist();
                renderChecklist();
                showFloatingMessage('é¡¹ç›®å·²åˆ é™¤æˆåŠŸï¼', 'success');
            }
        }

        // ç¼–è¾‘é¡¹ç›®
        function editItem(index) {
            const editInputs = document.getElementById(`editInputs${index}`);
            if (editInputs) {
                editInputs.classList.remove('d-none');
                document.getElementById(`editTitle${index}`).focus();
            } else {
                showFloatingMessage('é”™è¯¯ï¼šæœªæ‰¾åˆ°ç¼–è¾‘è¾“å…¥æ¡†', 'error');
            }
        }

        // ä¿å­˜ç¼–è¾‘
        function saveEdit(index) {
            const newTitle = document.getElementById(`editTitle${index}`).value.trim();
            const newContent = document.getElementById(`editContent${index}`).value.trim();
            
            if (newTitle && newContent) {
                checklist[index].title = newTitle;
                checklist[index].content = newContent;
                saveChecklist();
                renderChecklist();
                showFloatingMessage('é¡¹ç›®æ›´æ–°æˆåŠŸï¼', 'success');
            } else {
                showFloatingMessage('æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º', 'warning');
            }
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit(index) {
            const editInputs = document.getElementById(`editInputs${index}`);
            if (editInputs) {
                editInputs.classList.add('d-none');
            }
        }

        // å¤åˆ¶é¡¹ç›®å†…å®¹
        function copyItem(index) {
            const item = checklist[index];
            const textToCopy = `${item.title}\n${item.content}`;
            navigator.clipboard.writeText(textToCopy)
                .then(() => showFloatingMessage('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success'))
                .catch(err => {
                    showFloatingMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶', 'warning');
                });
        }

        // ä¿å­˜æ¸…å•åˆ°localStorage
        function saveChecklist() {
            localStorage.setItem('checklist', JSON.stringify(checklist));
        }

        // é‡ç½®æ¸…å•
        function resetChecklist() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é¡¹ç›®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                // é‡Šæ”¾æ‰€æœ‰å›¾ç‰‡èµ„æº
                imageBlobs.forEach((_, imageId) => {
                    const item = checklist.find(i => i.imageId === imageId);
                    if (item && item.imagePath) {
                        URL.revokeObjectURL(item.imagePath);
                    }
                });
                
                imageBlobs.clear();
                checklist = [];
                imageIndex = 1;
                saveChecklist();
                renderChecklist();
                showFloatingMessage('æ¸…å•å·²é‡ç½®', 'warning');
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notificationArea = document.getElementById('notification-area');
            if (!notificationArea) return;
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button class="notification-close" onclick="this.parentElement.remove()">Ã—</button>
            `;
            notificationArea.appendChild(notification);
            
            // è‡ªåŠ¨ç§»é™¤é€šçŸ¥
            setTimeout(() => {
                if (notification && notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html>
