<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>清单工具箱 v1</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background-color: #f8f9fa;
            padding-top: 130px;
        }
        .input-group-fixed {
            position: fixed;
            top: 0;
            width: 100%;
            max-width: 1200px;
            background-color: #fff;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1030;
            margin: 0 auto;
            left: 0;
            right: 0;
            border-bottom: 1px solid #dee2e6;
        }
        .preview-img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 4px;
            transition: transform 0.2s;
        }
        .preview-img:hover {
            transform: scale(1.5);
        }
        
        /* 悬浮消息区域 */
        #floating-message {
            position: fixed;
            top: 85px;
            left: 50%;
            transform: translateX(-50%);
            min-width: 300px;
            max-width: 80%;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 2000; /* 最高层级 */
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none; /* 允许点击穿透 */
        }
        
        #floating-message.show {
            opacity: 1;
        }
        
        /* 通知系统样式 */
        #notification-area {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            z-index: 1500;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        
        .notification {
            padding: 12px 15px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 10px;
            transform: translateX(110%);
            transition: transform 0.3s ease-out;
            opacity: 0.95;
            animation: slide-in 0.3s forwards, fade-out 0.5s 2.5s forwards;
            display: flex;
            align-items: center;
            justify-content: space-between;
            pointer-events: auto;
        }
        
        @keyframes slide-in {
            to { transform: translateX(0); }
        }
        
        @keyframes fade-out {
            to { opacity: 0; transform: translateY(10px); }
        }
        
        .notification-success {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        
        .notification-info {
            background-color: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        
        .notification-warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }
        
        .notification-danger {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        
        .notification-close {
            cursor: pointer;
            font-size: 18px;
            color: inherit;
            background: none;
            border: none;
            padding: 0 5px;
            opacity: 0.7;
            margin-left: 8px;
        }
        
        .notification-close:hover {
            opacity: 1;
        }
        
        /* 日志控制台样式 */
        #console-log {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 350px;
            max-height: 200px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1400;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        #console-log .log-entry {
            margin: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 3px;
        }
        
        #console-log .log-time {
            color: #aaa;
            margin-right: 5px;
        }
        
        #console-log .log-info {
            color: #8adbff;
        }
        
        #console-log .log-error {
            color: #ff8a8a;
        }
        
        #console-log .log-warning {
            color: #ffcc66;
        }
        
        #console-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        #console-header button {
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            padding: 0 5px;
            font-size: 14px;
        }
        
        #console-header button:hover {
            color: #fff;
        }
        
        .icon-btn {
            width: 40px;
            text-align: center;
            position: relative;
        }
        
        .toggle-btn {
            padding: 2px 8px;
            min-width: 80px;
            text-align: center;
        }
        
        .btn-purple {
            background-color: #6f42c1;
            color: white;
        }
        
        .btn-purple:hover {
            background-color: #5a32a3;
            color: white;
        }
        
        .edit-inputs {
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
            margin-top: 10px;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .table thead {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .table th {
            background-color: #f8f9fa;
        }
        
        .table td {
            vertical-align: middle;
            padding: 0.75rem;
        }
        
        .table-striped > tbody > tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .table-container .table {
            border-radius: 8px;
            overflow: hidden;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        /* 页面锁定指示器 */
        .page-lock-indicator {
            position: fixed;
            top: 15px;
            right: 20px;
            z-index: 2100;
            font-size: 1.25rem;
            color: #495057;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.7);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        
        .page-lock-indicator:hover {
            background-color: rgba(255, 255, 255, 0.9);
            transform: scale(1.05);
        }
        
        .page-locked {
            color: #dc3545;
        }
        
        @media (max-width: 768px) {
            body {
                padding-top: 170px;
            }
            .input-group-fixed {
                padding: 10px;
            }
            .table-container {
                margin-top: 30px;
            }
            #notification-area {
                width: calc(100% - 40px);
                max-width: 500px;
            }
            #floating-message {
                width: 90%;
                max-width: none;
                top: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 固定在顶部的输入组 -->
        <div class="input-group-fixed">
            <h4 class="mb-3">清单工具箱 v1</h4>
            <div class="input-group mb-2">
                <button class="btn btn-primary icon-btn" id="loadBtn" title="加载已保存的清单">📂</button>
                <input type="text" class="form-control" id="titleInput" placeholder="输入标题">
                <input type="text" class="form-control" id="contentInput" placeholder="输入内容">
                <input type="text" class="form-control" id="imageUrlInput" placeholder="图片链接（或使用粘贴截图按钮）" readonly>
                <button class="btn btn-warning icon-btn" id="pasteBtn" title="粘贴截图">📋</button>
                <button class="btn btn-success icon-btn" id="addBtn" title="添加项目">➕</button>
                <button class="btn btn-info icon-btn" id="saveBtn" title="保存清单">💾</button>
                <button class="btn btn-secondary icon-btn" id="resetBtn" title="重置清单">🔄</button>
                <button class="btn btn-outline-secondary icon-btn" id="toggleLogBtn" title="显示/隐藏日志">🔍</button>
                <button class="btn btn-outline-success icon-btn" id="exportBtn" title="导出清单与图片">📤</button>
            </div>
        </div>
        
        <!-- 页面锁定按钮 -->
        <div class="page-lock-indicator" id="pageLockBtn" title="锁定/解锁页面">🔓</div>
        
        <!-- 浮动消息 (用于显示重要日志) -->
        <div id="floating-message"></div>
        
        <!-- 通知区域 -->
        <div id="notification-area"></div>
        
        <!-- 日志控制台区域 -->
        <div id="console-log">
            <div id="console-header">
                <span>控制台日志</span>
                <div>
                    <button id="clearLogBtn" title="清空日志">🗑️</button>
                    <button id="closeLogBtn" title="关闭">✖</button>
                </div>
            </div>
            <div id="console-content"></div>
        </div>
        
        <div class="table-container">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th style="width: 10%;">状态</th>
                        <th style="width: 5%;">序号</th>
                        <th style="width: 20%;">标题</th>
                        <th style="width: 25%;">内容</th>
                        <th style="width: 15%;">预览</th>
                        <th style="width: 25%;">操作</th>
                    </tr>
                </thead>
                <tbody id="checklistBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script>
        // 全局变量
        let checklist = [];
        let imageIndex = 1;
        let logVisible = false;
        let floatingMessageTimeout = null;
        let pageIsLocked = false;
        let imageBlobs = new Map(); // 存储图片blob的映射
        let tooltips = []; // 存储所有tooltip实例的数组，用于手动处理
        
        // 确保DOM完全加载后再执行JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM完全加载，初始化清单...');

            // 加载之前保存的清单
            checklist = JSON.parse(localStorage.getItem('checklist')) || [];
            
            // 初始化工具提示            initTooltips();
            
            // 按钮事件绑定
            document.getElementById('loadBtn').onclick = loadChecklist;
            document.getElementById('pasteBtn').onclick = triggerPaste;
            document.getElementById('addBtn').onclick = addItem;
            document.getElementById('saveBtn').onclick = saveChecklist;
            document.getElementById('resetBtn').onclick = resetChecklist;
            document.getElementById('toggleLogBtn').onclick = toggleLogConsole;
            document.getElementById('clearLogBtn').onclick = clearLogConsole;
            document.getElementById('closeLogBtn').onclick = hideLogConsole;
            document.getElementById('exportBtn').onclick = exportChecklist;
            document.getElementById('pageLockBtn').onclick = togglePageLock;
            
            // 为图片输入添加粘贴监听器
            const imageUrlInput = document.getElementById('imageUrlInput');
            if (imageUrlInput) {
                imageUrlInput.addEventListener('paste', handlePaste);
            }
            
            // 添加表格事件委托
            document.getElementById('checklistBody').addEventListener('click', handleTableEvents);
            
            // 添加离开页面前提示
            window.addEventListener('beforeunload', handleBeforeUnload);
            
            // 首次渲染清单
            renderChecklist();
            showFloatingMessage('系统初始化完成！', 'success', 2000);
        });
        
        // 初始化工具提示
        function initTooltips() {
            // 销毁先前的工具提示
            if (tooltips.length > 0) {
                tooltips.forEach(tooltip => {
                    if (tooltip && typeof tooltip.dispose === 'function') {
                        tooltip.dispose();
                    }
                });
                tooltips = [];
            }
            
            // 创建新的工具提示实例
            const tooltipTriggerList = document.querySelectorAll('[title]');
            tooltips = [...tooltipTriggerList].map(element => {
                return new bootstrap.Tooltip(element, {
                    trigger: 'hover focus',
                    delay: { show: 500, hide: 100 }
                });
            });
        }
        
        // 显示浮动消息
        function showFloatingMessage(message, type = 'info', duration = 3000) {
            const messageEl = document.getElementById('floating-message');
            if (!messageEl) return;
            
            // 清除之前的计时器
            if (floatingMessageTimeout) {
                clearTimeout(floatingMessageTimeout);
            }
            
            // 设置消息颜色
            let color = '#17a2b8'; // info
            if (type === 'error') color = '#dc3545';
            if (type === 'warning') color = '#ffc107';
            if (type === 'success') color = '#28a745';
            
            messageEl.style.backgroundColor = `rgba(0, 0, 0, 0.85)`;
            messageEl.style.borderLeft = `4px solid ${color}`;
            messageEl.textContent = message;
            messageEl.classList.add('show');
            
            // 设置自动隐藏
            floatingMessageTimeout = setTimeout(() => {
                messageEl.classList.remove('show');
            }, duration);
        }
        
        // 阻止页面刷新提示
        function handleBeforeUnload(event) {
            if (pageIsLocked || imageBlobs.size > 0) {
                const message = '警告：您有未保存的图片。请在离开前导出。';
                event.returnValue = message;
                return message;
            }
        }
        
        // 切换页面锁定状态
        function togglePageLock() {
            pageIsLocked = !pageIsLocked;
            const lockBtn = document.getElementById('pageLockBtn');
            
            if (pageIsLocked) {
                lockBtn.textContent = '🔒';
                lockBtn.classList.add('page-locked');
                showFloatingMessage('页面已锁定。刷新将被阻止。', 'info');
            } else {
                lockBtn.textContent = '🔓';
                lockBtn.classList.remove('page-locked');
                showFloatingMessage('页面已解锁。', 'info');
            }
        }
        
        // 日志控制台功能
        function toggleLogConsole() {
            const logConsole = document.getElementById('console-log');
            logVisible = !logVisible;
            logConsole.style.display = logVisible ? 'block' : 'none';
        }
        
        function hideLogConsole() {
            const logConsole = document.getElementById('console-log');
            logVisible = false;
            logConsole.style.display = 'none';
        }
        
        function clearLogConsole() {
            const consoleContent = document.getElementById('console-content');
            if (consoleContent) {
                consoleContent.innerHTML = '';
            }
        }
        
        // 添加日志条目
        function addLogEntry(message, type = 'info') {
            const consoleContent = document.getElementById('console-content');
            if (!consoleContent) return;
            
            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="log-time">${timeStr}</span> ${message}`;
            
            consoleContent.appendChild(logEntry);
            consoleContent.scrollTop = consoleContent.scrollHeight;
        }
        
        // 处理表格事件
        function handleTableEvents(event) {
            const target = event.target;
            const button = target.closest('button');
            if (!button) return;
            
            const action = button.getAttribute('data-action');
            const index = parseInt(button.getAttribute('data-index'), 10);
            
            if (action === 'toggle') {
                toggleDone(index);
            } else if (action === 'edit') {
                editItem(index);
            } else if (action === 'remove') {
                removeItem(index);
            } else if (action === 'copy') {
                copyItem(index);
            } else if (action === 'saveEdit') {
                saveEdit(index);
            } else if (action === 'cancelEdit') {
                cancelEdit(index);
            }
        }

        // 从localStorage加载清单
        function loadChecklist() {
            checklist = JSON.parse(localStorage.getItem('checklist')) || [];
            renderChecklist();
            showFloatingMessage('清单已从本地存储加载成功！', 'success');
        }

        // 触发粘贴功能
        function triggerPaste() {
            const pasteInput = document.getElementById('imageUrlInput');
            if (pasteInput) {
                pasteInput.focus();
                showFloatingMessage('请按 Ctrl+V 将截图粘贴到输入框', 'info');
            } else {
                showFloatingMessage('错误：无法触发粘贴 - 未找到输入框', 'error');
            }
        }

        // 处理粘贴事件
        function handlePaste(event) {
            event.preventDefault();
            const items = event.clipboardData.items;
            if (!items || items.length === 0) {
                showFloatingMessage('剪贴板中无可用数据。请确保已复制图片', 'warning');
                return;
            }

            for (let item of items) {
                if (item.type.startsWith('image/')) {
                    const blob = item.getAsFile();
                    if (!blob) {
                        showFloatingMessage('无法从剪贴板获取图片。请重试', 'error');
                        return;
                    }
                    
                    // 生成唯一标识符作为图片ID
                    const imageId = `img_${Date.now()}_${imageIndex}`;
                    imageIndex++;
                    
                    // 存储Blob到映射中
                    imageBlobs.set(imageId, blob);
                    
                    // 创建临时URL用于显示
                    const dataUrl = URL.createObjectURL(blob);
                    
                    // 捕获当前标题和内容作为上下文
                    const title = document.getElementById('titleInput').value.trim() || '截图';
                    const content = document.getElementById('contentInput').value.trim() || '粘贴的图片';
                    
                    checklist.push({ 
                        title, 
                        content, 
                        imagePath: dataUrl, 
                        imageId: imageId,
                        done: false 
                    });
                    
                    saveChecklist();
                    renderChecklist();
                    showFloatingMessage('图片已粘贴，项目已添加成功！', 'success');
                    
                    // 清空输入框
                    document.getElementById('titleInput').value = '';
                    document.getElementById('contentInput').value = '';
                    document.getElementById('imageUrlInput').value = '';
                    return;
                }
            }
            
            showFloatingMessage('剪贴板数据不是图片。请复制图片后重试', 'warning');
        }

        // 添加新项目
        function addItem() {
            const title = document.getElementById('titleInput').value.trim();
            const content = document.getElementById('contentInput').value.trim();
            const imageUrl = document.getElementById('imageUrlInput').value.trim();

            if (title && content) {
                checklist.push({ 
                    title, 
                    content, 
                    imagePath: imageUrl || '',
                    done: false 
                });
                
                saveChecklist();
                renderChecklist();
                showFloatingMessage('新项目已添加成功！', 'success');
                
                // 清空输入
                document.getElementById('titleInput').value = '';
                document.getElementById('contentInput').value = '';
                document.getElementById('imageUrlInput').value = '';
            } else {
                showFloatingMessage('请填写标题和内容字段', 'warning');
            }
        }

        // 导出清单和图片
        function exportChecklist() {
            // 如果没有图片数据，只导出JSON
            if (imageBlobs.size === 0) {
                exportJsonFile();
                showFloatingMessage('导出成功（无图片数据）', 'success');
                return;
            }
            
            // 加载JSZip库并创建ZIP
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
            script.onload = function() {
                const zip = new JSZip();
                
                // 添加清单数据
                const checklistData = JSON.stringify(checklist, null, 2);
                zip.file('checklist.json', checklistData);
                
                // 添加图片文件
                imageBlobs.forEach((blob, imageId) => {
                    zip.file(`images/${imageId}.png`, blob);
                });
                
                // 生成ZIP文件并下载
                zip.generateAsync({type: 'blob'}).then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `checklist_export_${new Date().toISOString().slice(0, 10)}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showFloatingMessage('导出完成！', 'success');
                });
            };
            
            script.onerror = function() {
                console.error('无法加载JSZip库');
                showFloatingMessage('导出失败，降级为仅导出JSON', 'warning');
                exportJsonFile();
            };
            
            document.head.appendChild(script);
        }
        
        // 仅导出JSON文件
        function exportJsonFile() {
            const data = JSON.stringify(checklist, null, 2);
            const blob = new Blob([data], {type: 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `checklist_export_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 渲染清单
        function renderChecklist() {
            const tbody = document.getElementById('checklistBody');
            if (!tbody) {
                showFloatingMessage('错误: 未找到清单表格主体', 'error');
                return;
            }
            
            tbody.innerHTML = '';
            
            if (checklist.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="text-center py-4">
                        <div class="text-muted">清单中没有项目。使用上方表单添加项目。</div>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary" onclick="document.getElementById('titleInput').focus()">
                                添加第一个项目 ➕
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }
            
            checklist.forEach((item, index) => {
                const isDone = item.done || false;
                const doneClass = isDone ? 'text-decoration-line-through text-muted' : '';
                const hasImage = item.imagePath && item.imagePath.trim() !== '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <button class="btn btn-sm ${isDone ? 'btn-success' : 'btn-outline-secondary'} toggle-btn" 
                                data-action="toggle" data-index="${index}" title="${isDone ? '标记为未完成' : '标记为已完成'}">
                            ${isDone ? '✓ 已完成' : '◯ 未完成'}
                        </button>
                    </td>
                    <td>${index + 1}</td>
                    <td class="${doneClass}">${item.title}</td>
                    <td class="${doneClass}">${item.content}</td>
                    <td>${hasImage ? `<a href="${item.imagePath}" target="_blank"><img src="${item.imagePath}" alt="预览" class="preview-img"></a>` : '无图片'}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" data-action="edit" data-index="${index}" title="编辑项目">✏️</button>
                            <button class="btn btn-danger btn-sm" data-action="remove" data-index="${index}" title="删除项目">🗑️</button>
                        </div>
                        <div class="edit-inputs d-none" id="editInputs${index}">
                            <input type="text" class="form-control form-control-sm mb-2" id="editTitle${index}" value="${item.title}" placeholder="编辑标题">
                            <input type="text" class="form-control form-control-sm mb-2" id="editContent${index}" value="${item.content}" placeholder="编辑内容">
                            <input type="text" class="form-control form-control-sm mb-2" id="editImageUrl${index}" value="${item.imagePath || ''}" placeholder="图片链接（可选）" readonly>
                            <div class="mt-2">
                                <button class="btn btn-info btn-sm" data-action="saveEdit" data-index="${index}">保存</button>
                                <button class="btn btn-secondary btn-sm" data-action="cancelEdit" data-index="${index}">取消</button>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // 重新初始化工具提示
            initTooltips();
        }

        // 切换完成状态
        function toggleDone(index) {
            if (checklist[index]) {
                checklist[index].done = !checklist[index].done;
                saveChecklist();
                renderChecklist();
                showFloatingMessage(`项目已${checklist[index].done ? '标记为已完成' : '标记为未完成'}`, 'success');
            }
        }

        // 删除项目
        function removeItem(index) {
            if (confirm('确定要删除这个项目吗？')) {
                // 如果有关联的图片，释放资源
                const item = checklist[index];
                if (item.imageId && imageBlobs.has(item.imageId)) {
                    URL.revokeObjectURL(item.imagePath);
                    imageBlobs.delete(item.imageId);
                }
                
                checklist.splice(index, 1);
                saveChecklist();
                renderChecklist();
                showFloatingMessage('项目已删除成功！', 'success');
            }
        }

        // 编辑项目
        function editItem(index) {
            const editInputs = document.getElementById(`editInputs${index}`);
            if (editInputs) {
                editInputs.classList.remove('d-none');
                document.getElementById(`editTitle${index}`).focus();
            } else {
                showFloatingMessage('错误：未找到编辑输入框', 'error');
            }
        }

        // 保存编辑
        function saveEdit(index) {
            const newTitle = document.getElementById(`editTitle${index}`).value.trim();
            const newContent = document.getElementById(`editContent${index}`).value.trim();
            
            if (newTitle && newContent) {
                checklist[index].title = newTitle;
                checklist[index].content = newContent;
                saveChecklist();
                renderChecklist();
                showFloatingMessage('项目更新成功！', 'success');
            } else {
                showFloatingMessage('标题和内容不能为空', 'warning');
            }
        }

        // 取消编辑
        function cancelEdit(index) {
            const editInputs = document.getElementById(`editInputs${index}`);
            if (editInputs) {
                editInputs.classList.add('d-none');
            }
        }

        // 复制项目内容
        function copyItem(index) {
            const item = checklist[index];
            const textToCopy = `${item.title}\n${item.content}`;
            navigator.clipboard.writeText(textToCopy)
                .then(() => showFloatingMessage('内容已复制到剪贴板', 'success'))
                .catch(err => {
                    showFloatingMessage('复制失败，请手动选择并复制', 'warning');
                });
        }

        // 保存清单到localStorage
        function saveChecklist() {
            localStorage.setItem('checklist', JSON.stringify(checklist));
        }

        // 重置清单
        function resetChecklist() {
            if (confirm('确定要清空所有项目吗？此操作不可恢复！')) {
                // 释放所有图片资源
                imageBlobs.forEach((_, imageId) => {
                    const item = checklist.find(i => i.imageId === imageId);
                    if (item && item.imagePath) {
                        URL.revokeObjectURL(item.imagePath);
                    }
                });
                
                imageBlobs.clear();
                checklist = [];
                imageIndex = 1;
                saveChecklist();
                renderChecklist();
                showFloatingMessage('清单已重置', 'warning');
            }
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notificationArea = document.getElementById('notification-area');
            if (!notificationArea) return;
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button class="notification-close" onclick="this.parentElement.remove()">×</button>
            `;
            notificationArea.appendChild(notification);
            
            // 自动移除通知
            setTimeout(() => {
                if (notification && notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html>
